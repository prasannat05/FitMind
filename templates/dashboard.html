{% extends "base.html" %}
{% block title %}Dashboard | FitMind{% endblock %}

{% block content %}
<div class="row">

  <!-- Left pane: Charts -->
  <section class="col-lg-8 mb-4">
    <div class="card shadow-sm">
      <div class="card-header fs-5 fw-bold">üìä Activity Overview</div>
      <div class="card-body">
        <canvas id="stepsChart" height="180" aria-label="Steps over time chart" role="img"></canvas>
        <canvas id="caloriesChart" height="180" class="mt-4" aria-label="Calories burned over time chart" role="img"></canvas>
      </div>
    </div>
  </section>

  <!-- Right pane: Log, AI Rec, Typing Chat -->
  <section class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header fs-5 fw-bold">üìù Log Daily Metrics</div>
      <div class="card-body">
        <form id="logForm" novalidate>
          <div class="mb-2">
            <label for="steps" class="form-label visually-hidden">Steps</label>
            <input id="steps" type="number" class="form-control" placeholder="Steps" min="0" required aria-required="true" />
          </div>
          <div class="mb-2">
            <label for="calories" class="form-label visually-hidden">Calories Burned</label>
            <input id="calories" type="number" class="form-control" placeholder="Calories Burned" min="0" step="0.1" required aria-required="true" />
          </div>
          <div class="mb-2">
            <label for="heart_rate" class="form-label visually-hidden">Heart Rate</label>
            <input id="heart_rate" type="number" class="form-control" placeholder="Heart Rate (bpm)" min="0" />
          </div>
          <div class="mb-2">
            <label for="sleep_hours" class="form-label visually-hidden">Sleep Hours</label>
            <input id="sleep_hours" type="number" class="form-control" placeholder="Sleep Hours" min="0" step="0.1" />
          </div>
          <div class="mb-2">
            <label for="hydration" class="form-label visually-hidden">Hydration</label>
            <input id="hydration" type="number" class="form-control" placeholder="Hydration (L)" min="0" step="0.1" />
          </div>
          <div class="mb-2">
            <label for="mood" class="form-label visually-hidden">Mood</label>
            <select id="mood" class="form-select" aria-label="Mood selector">
              <option value="" selected>Mood</option>
              <option>Happy</option>
              <option>Neutral</option>
              <option>Stressed</option>
              <option>Tired</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">Log Data</button>
          <div id="logStatus" class="mt-2 text-success" role="alert" aria-live="polite" style="display: none;">Logged successfully!</div>
          <div id="logError" class="mt-2 text-danger" role="alert" aria-live="polite" style="display: none;">Error saving data</div>
        </form>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header fs-5 fw-bold">ü§ñ AI Recommendations</div>
      <div class="card-body" id="recommendations" aria-live="polite" aria-busy="true" style="min-height: 120px;">
        Loading recommendations...
      </div>
      <div class="card-footer">
        <button id="refreshRec" class="btn btn-outline-secondary btn-sm w-100">Refresh Recommendations</button>
      </div>
    </div>

    <!-- Typing AI Chat -->
    <div class="card shadow-sm">
      <div class="card-header fs-5 fw-bold">üí¨ Chat with AI Coach</div>
      <div class="card-body d-flex flex-column" style="height: 320px;">
        <div id="chatWindow" class="border rounded p-3 bg-light flex-grow-1 overflow-auto" aria-live="polite" aria-label="Chat messages"></div>
        <form id="chatForm" class="mt-2 d-flex gap-2" autocomplete="off" aria-label="Chat input form">
          <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." required aria-required="true" />
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}
<script>
  // Show status messages
  async function showLogStatus(success) {
    const statusEl = document.getElementById('logStatus');
    const errorEl = document.getElementById('logError');
    if (success) {
      statusEl.style.display = 'block';
      errorEl.style.display = 'none';
      setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
    } else {
      statusEl.style.display = 'none';
      errorEl.style.display = 'block';
      setTimeout(() => { errorEl.style.display = 'none'; }, 3000);
    }
  }

  // Submit health log data
  async function submitLogData(e) {
    e.preventDefault();
    const data = {
      date: new Date().toISOString().slice(0, 10),
      steps: parseInt(document.getElementById('steps').value) || 0,
      calories: parseFloat(document.getElementById('calories').value) || 0,
      heart_rate: parseInt(document.getElementById('heart_rate').value) || 0,
      sleep_hours: parseFloat(document.getElementById('sleep_hours').value) || 0,
      hydration: parseFloat(document.getElementById('hydration').value) || 0,
      mood: document.getElementById('mood').value || ""
    };
    try {
      const resp = await fetch('/log', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await resp.json();
      if (result.success) {
        showLogStatus(true);
        loadLogsAndCharts();
        e.target.reset();
      } else {
        showLogStatus(false);
      }
    } catch {
      showLogStatus(false);
    }
  }

  // Chat UI helpers
  function appendMessage(sender, text) {
    const chatWindow = document.getElementById('chatWindow');
    const msgDiv = document.createElement('div');
    msgDiv.className = sender === 'user' ? 'chat-message user-message' : 'chat-message ai-message';
    msgDiv.textContent = text;
    chatWindow.appendChild(msgDiv);
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  async function sendMessage(message) {
    appendMessage('user', message);
    appendMessage('ai', '‚Ä¶'); // Loading indicator

    try {
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await response.json();

      // Replace loading indicator with actual AI reply
      const chatWindow = document.getElementById('chatWindow');
      const loadingMsg = Array.from(chatWindow.children).find(child => child.textContent === '‚Ä¶');
      if (loadingMsg) {
        loadingMsg.textContent = data.reply;
        loadingMsg.className = 'chat-message ai-message';
      }
    } catch (err) {
      const chatWindow = document.getElementById('chatWindow');
      const loadingMsg = Array.from(chatWindow.children).find(child => child.textContent === '‚Ä¶');
      if (loadingMsg) {
        loadingMsg.textContent = "Sorry, something went wrong. Please try again.";
        loadingMsg.className = 'chat-message ai-message error-message';
      }
    }
  }

  // Handle chat form submit
  function setupChat() {
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    chatForm.addEventListener('submit', e => {
      e.preventDefault();
      const msg = chatInput.value.trim();
      if (msg === '') return;
      chatInput.value = '';
      sendMessage(msg);
    });
  }

  // Initialize after DOM loaded
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('logForm').addEventListener('submit', submitLogData);
    document.getElementById('refreshRec').addEventListener('click', loadRecommendations);
    setupChat();

    loadLogsAndCharts();
    loadRecommendations();
    loadTheme();
  });
  
  // Include loadLogsAndCharts(), loadRecommendations(), loadTheme(), toggleTheme() functions in your static/scripts.js
</script>
{% endblock %}
